{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
PROBE: AI Analytics dashboard page (Phase 3) â€” sub-tab layout by feature.
*/}}

{{if .Disabled}}
<p>AI triage is disabled. Configure <code>ai_triage</code> in your config file to enable analytics.</p>
{{else}}

<style>
.analytics-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
.analytics-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 18px 20px; transition: all var(--transition); position: relative; overflow: hidden; }
.analytics-card:hover { border-color: var(--border-light); transform: translateY(-1px); }
.analytics-card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
.analytics-card .value { font-size: 26px; font-weight: 700; margin-top: 6px; color: var(--text-primary); letter-spacing: -0.03em; font-variant-numeric: tabular-nums; }
.analytics-card .sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.chart-row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
.chart-box { flex: 1; min-width: 400px; border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 12px; background: var(--bg-card); }
.chart-box-small { flex: 1; min-width: 300px; max-width: 400px; border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 12px; background: var(--bg-card); }
.section-title { font-size: 14px; font-weight: 600; margin: 28px 0 14px 0; padding-bottom: 8px; border-bottom: 1px solid var(--border-light); color: var(--text-secondary); letter-spacing: 0.02em; }
.section-title:first-of-type { margin-top: 12px; }
.analytics-pane { display: none; }
.analytics-pane.active { display: block; }
</style>

<div class="tab-nav" id="analytics-tabs">
  <a href="#" data-pane="dashboard" class="active">Dashboard</a>
  <a href="#" data-pane="triage">AI Triage</a>
  <a href="#" data-pane="embeddings">Embeddings</a>
  <a href="#" data-pane="strategy">Strategy</a>
</div>

<!-- ===== DASHBOARD PANE ===== -->
<div class="analytics-pane active" id="pane-dashboard">

<div class="analytics-cards">
	<div class="analytics-card">
		<div class="label">Total Cost</div>
		<div class="value">${{printf "%.2f" .TotalCostUSD}}</div>
		<div class="sub">~{{.TotalCostKRW}} KRW</div>
	</div>
	<div class="analytics-card">
		<div class="label">Today</div>
		<div class="value">${{printf "%.3f" .TodayCostUSD}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Projected/Month</div>
		<div class="value">${{printf "%.2f" .ProjectedMonthUSD}}</div>
		<div class="sub">~{{.ProjectedMonthKRW}} KRW</div>
	</div>
	<div class="analytics-card">
		<div class="label">Analyzed</div>
		<div class="value">{{.AnalyzedCount}}</div>
		<div class="sub">crashes</div>
	</div>
	<div class="analytics-card">
		<div class="label">High Risk</div>
		<div class="value" style="color:var(--danger)">{{.HighRiskCount}}</div>
		<div class="sub">score &ge; 70</div>
	</div>
	<div class="analytics-card">
		<div class="label">Success Rate</div>
		<div class="value">{{printf "%.1f" .SuccessRate}}%</div>
		<div class="sub">{{.TotalCalls}} total calls</div>
	</div>
</div>

<div class="section-title">Cost Analytics</div>
<div class="chart-row">
	<div class="chart-box"><div id="chart_daily_cost" style="height:300px"></div></div>
	<div class="chart-box-small"><div id="chart_cost_breakdown" style="height:300px"></div></div>
</div>
<div class="chart-row">
	<div class="chart-box"><div id="chart_cumulative" style="height:280px"></div></div>
</div>

{{if or .CostPerCrash .CostPerDay}}
<table class="list_table" style="width:auto">
<caption>Cost Efficiency:</caption>
<tr><td class="title">Cost per Crash</td><td>${{printf "%.4f" .CostPerCrash}}</td></tr>
<tr><td class="title">Cost per High-Risk</td><td>${{printf "%.4f" .CostPerHighRisk}}</td></tr>
<tr><td class="title">Avg Cost per Day</td><td>${{printf "%.4f" .CostPerDay}}</td></tr>
</table>
{{end}}

{{if .TokenEfficiency}}
<table class="list_table" style="width:auto">
<caption>Token Efficiency (avg per call):</caption>
<thead><tr><th>Type</th><th>Avg Input</th><th>Avg Output</th><th>Avg Cost</th></tr></thead>
<tbody>
{{range .TokenEfficiency}}
<tr><td>{{.Label}}</td><td class="stat">{{.Input}}</td><td class="stat">{{.Output}}</td><td class="stat">${{printf "%.4f" .Cost}}</td></tr>
{{end}}
</tbody>
</table>
{{end}}

<div class="section-title">API Performance</div>
<div class="chart-row">
	<div class="chart-box"><div id="chart_calls_per_day" style="height:280px"></div></div>
</div>
<table class="list_table" style="width:auto">
<caption>Token Usage by Type:</caption>
<thead><tr><th>Type</th><th>Calls</th><th>Avg Input</th><th>Avg Output</th></tr></thead>
<tbody>
<tr><td>Crash Analysis</td><td class="stat">{{.AvgCrashTokens.Count}}</td><td class="stat">{{.AvgCrashTokens.AvgInput}}</td><td class="stat">{{.AvgCrashTokens.AvgOutput}}</td></tr>
<tr><td>Strategy</td><td class="stat">{{.AvgStrategyTokens.Count}}</td><td class="stat">{{.AvgStrategyTokens.AvgInput}}</td><td class="stat">{{.AvgStrategyTokens.AvgOutput}}</td></tr>
</tbody>
</table>
{{if .ErrorLog}}
<br>
<table class="list_table" style="width:auto">
<caption>Recent Errors (last {{len .ErrorLog}}):</caption>
<thead><tr><th>Time</th><th>Type</th><th>Error</th></tr></thead>
<tbody>
{{range .ErrorLog}}
<tr>
	<td class="time">{{formatTime .Time}}</td>
	<td>{{.Type}}</td>
	<td style="color:var(--danger); max-width:600px; word-wrap:break-word">{{.Error}}</td>
</tr>
{{end}}
</tbody>
</table>
{{end}}

</div>

<!-- ===== AI TRIAGE PANE ===== -->
<div class="analytics-pane" id="pane-triage">

<div class="analytics-cards">
	<div class="analytics-card">
		<div class="label">Analyzed</div>
		<div class="value">{{.AnalyzedCount}}</div>
		<div class="sub">crashes</div>
	</div>
	<div class="analytics-card">
		<div class="label">Avg Score</div>
		<div class="value">{{printf "%.1f" .AvgScore}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Max Score</div>
		<div class="value" style="color:var(--danger)">{{.MaxScore}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">High Risk</div>
		<div class="value" style="color:var(--danger)">{{.HighRiskCount}}</div>
		<div class="sub">score &ge; 70</div>
	</div>
</div>

<div class="section-title">Score Distribution</div>
<div class="chart-row">
	<div class="chart-box"><div id="chart_score_dist" style="height:300px"></div></div>
	<div class="chart-box-small"><div id="chart_exploit_class" style="height:300px"></div></div>
</div>

{{if .VulnTypes}}
<table class="list_table" style="width:auto">
<caption>Vulnerability Types:</caption>
<thead><tr><th>Type</th><th>Count</th><th>%</th></tr></thead>
<tbody>
{{range .VulnTypes}}
<tr><td>{{.Type}}</td><td class="stat">{{.Count}}</td><td class="stat">{{printf "%.1f" .Pct}}%</td></tr>
{{end}}
</tbody>
</table>
{{end}}

<div class="section-title">Crash Timeline</div>
<div class="chart-row">
	<div class="chart-box"><div id="chart_crash_timeline" style="height:300px"></div></div>
</div>

</div>

<!-- ===== EMBEDDINGS PANE ===== -->
<div class="analytics-pane" id="pane-embeddings">

<div class="analytics-cards">
	<div class="analytics-card">
		<div class="label">Embedding Cost</div>
		<div class="value">${{printf "%.4f" .EmbCostUSD}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Clusters</div>
		<div class="value">{{.EmbClusters}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Dedup Ratio</div>
		<div class="value">{{printf "%.1f" .DedupRatio}}%</div>
	</div>
	<div class="analytics-card">
		<div class="label">Combined Cost</div>
		<div class="value">${{printf "%.4f" .CombinedCostUSD}}</div>
		<div class="sub">~{{.CombinedCostKRW}} KRW (LLM + Embedding)</div>
	</div>
</div>

</div>

<!-- ===== STRATEGY PANE ===== -->
<div class="analytics-pane" id="pane-strategy">

<div class="analytics-cards">
	<div class="analytics-card">
		<div class="label">Seeds Injected</div>
		<div class="value">{{.TotalSeedsInjected}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Seeds Accepted</div>
		<div class="value" style="color:var(--success)">{{.TotalSeedsAccepted}}</div>
	</div>
	<div class="analytics-card">
		<div class="label">Weights Applied</div>
		<div class="value">{{.TotalWeightsApplied}}</div>
		<div class="sub">/ {{.TotalWeightsTotal}} total</div>
	</div>
	<div class="analytics-card">
		<div class="label">Focus Targets</div>
		<div class="value">{{.FocusTriggered}}</div>
	</div>
</div>

{{if .SyzGPTGenerated}}
<table class="list_table" style="width:auto">
<caption>SyzGPT Performance:</caption>
<tr><td class="title">Generated</td><td>{{.SyzGPTGenerated}} programs</td></tr>
<tr><td class="title">Valid</td><td>{{.SyzGPTValid}} ({{.SyzGPTValidRate}}%)</td></tr>
<tr><td class="title">Injected</td><td>{{.SyzGPTInjected}}</td></tr>
</table>
{{end}}

{{if .StrategyRuns}}
<br>
<table class="list_table" style="width:auto">
<caption>Recent Strategy Runs:</caption>
<thead><tr><th>Time</th><th>Seeds</th><th>Weights</th><th>Summary</th></tr></thead>
<tbody>
{{range .StrategyRuns}}
<tr>
	<td class="time">{{formatTime .Time}}</td>
	<td class="stat">{{.SeedsInjected}}&rarr;{{.SeedsAccepted}}</td>
	<td class="stat">{{.WeightsApplied}}</td>
	<td style="max-width:500px; word-wrap:break-word; white-space:pre-wrap">{{.Summary}}</td>
</tr>
{{end}}
</tbody>
</table>
{{end}}

</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
// Tab switching.
(function() {
	var tabs = document.querySelectorAll('#analytics-tabs a[data-pane]');
	tabs.forEach(function(tab) {
		tab.addEventListener('click', function(e) {
			e.preventDefault();
			tabs.forEach(function(t) { t.classList.remove('active'); });
			tab.classList.add('active');
			document.querySelectorAll('.analytics-pane').forEach(function(p) { p.classList.remove('active'); });
			var pane = document.getElementById('pane-' + tab.getAttribute('data-pane'));
			if (pane) pane.classList.add('active');
			// Redraw charts for the active pane.
			if (typeof google !== 'undefined' && google.visualization) drawAllCharts();
			// Re-apply i18n.
			var lang = localStorage.getItem('probe_lang');
			if (lang && lang !== 'en' && typeof applyI18n === 'function') applyI18n(lang);
		});
	});
})();

google.charts.load('current', {packages: ['corechart']});
google.charts.setOnLoadCallback(drawAllCharts);

function drawAllCharts() {
	drawDailyCost();
	drawCostBreakdown();
	drawCumulativeCost();
	drawScoreDist();
	drawExploitClass();
	drawCallsPerDay();
	drawCrashTimeline();
}

function drawDailyCost() {
	var el = document.getElementById('chart_daily_cost');
	if (!el || el.offsetParent === null) return;
	var raw = {{.DailyCostJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Date');
	dt.addColumn('number', 'Crash');
	dt.addColumn('number', 'Strategy');
	dt.addRows(raw);
	new google.visualization.ColumnChart(el).draw(dt, {
		title: 'Daily Cost (USD)', isStacked: true,
		colors: ['#6366f1', '#fbbf24'],
		legend: {position: 'top', textStyle: {color: '#94a3b8'}},
		chartArea: {width: '85%', height: '70%'},
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		vAxis: {format: '$#,##0.00', textStyle: {color: '#64748b'}, gridlines: {color: 'rgba(255,255,255,0.05)'}, baselineColor: 'rgba(255,255,255,0.08)'},
		hAxis: {textStyle: {color: '#64748b'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawCostBreakdown() {
	var el = document.getElementById('chart_cost_breakdown');
	if (!el || el.offsetParent === null) return;
	var raw = {{.CostBreakdownJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Type');
	dt.addColumn('number', 'Cost');
	dt.addRows(raw);
	new google.visualization.PieChart(el).draw(dt, {
		title: 'Cost Breakdown',
		colors: ['#6366f1', '#fbbf24'],
		chartArea: {width: '90%', height: '75%'},
		pieHole: 0.4,
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		legend: {textStyle: {color: '#94a3b8'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawCumulativeCost() {
	var el = document.getElementById('chart_cumulative');
	if (!el || el.offsetParent === null) return;
	var raw = {{.CumulativeCostJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Date');
	dt.addColumn('number', 'Cumulative');
	dt.addRows(raw);
	new google.visualization.LineChart(el).draw(dt, {
		title: 'Cumulative Cost (USD)',
		colors: ['#34d399'],
		curveType: 'function',
		legend: {position: 'none'},
		chartArea: {width: '85%', height: '70%'},
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		vAxis: {format: '$#,##0.00', textStyle: {color: '#64748b'}, gridlines: {color: 'rgba(255,255,255,0.05)'}, baselineColor: 'rgba(255,255,255,0.08)'},
		hAxis: {textStyle: {color: '#64748b'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawScoreDist() {
	var el = document.getElementById('chart_score_dist');
	if (!el || el.offsetParent === null) return;
	var raw = {{.ScoreDistJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Range');
	dt.addColumn('number', 'Count');
	dt.addRows(raw);
	new google.visualization.ColumnChart(el).draw(dt, {
		title: 'Score Distribution',
		colors: ['#f87171'],
		legend: {position: 'none'},
		chartArea: {width: '85%', height: '70%'},
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		vAxis: {minValue: 0, textStyle: {color: '#64748b'}, gridlines: {color: 'rgba(255,255,255,0.05)'}, baselineColor: 'rgba(255,255,255,0.08)'},
		hAxis: {textStyle: {color: '#64748b'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawExploitClass() {
	var el = document.getElementById('chart_exploit_class');
	if (!el || el.offsetParent === null) return;
	var raw = {{.ExploitClassJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Class');
	dt.addColumn('number', 'Count');
	dt.addRows(raw);
	new google.visualization.PieChart(el).draw(dt, {
		title: 'Exploit Classes',
		chartArea: {width: '90%', height: '75%'},
		pieHole: 0.4,
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		legend: {textStyle: {color: '#94a3b8'}},
		colors: ['#f87171', '#fbbf24', '#34d399', '#6366f1', '#22d3ee'],
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawCallsPerDay() {
	var el = document.getElementById('chart_calls_per_day');
	if (!el || el.offsetParent === null) return;
	var raw = {{.CallsPerDayJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Date');
	dt.addColumn('number', 'Crash');
	dt.addColumn('number', 'Strategy');
	dt.addRows(raw);
	new google.visualization.ColumnChart(el).draw(dt, {
		title: 'API Calls per Day', isStacked: true,
		colors: ['#6366f1', '#fbbf24'],
		legend: {position: 'top', textStyle: {color: '#94a3b8'}},
		chartArea: {width: '85%', height: '70%'},
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		vAxis: {minValue: 0, textStyle: {color: '#64748b'}, gridlines: {color: 'rgba(255,255,255,0.05)'}, baselineColor: 'rgba(255,255,255,0.08)'},
		hAxis: {textStyle: {color: '#64748b'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}

function drawCrashTimeline() {
	var el = document.getElementById('chart_crash_timeline');
	if (!el || el.offsetParent === null) return;
	var raw = {{.CrashTimelineJSON}};
	if (!raw || raw.length === 0) return;
	var dt = new google.visualization.DataTable();
	dt.addColumn('string', 'Time');
	dt.addColumn('number', 'High (>=70)');
	dt.addColumn('number', 'Medium (40-69)');
	dt.addColumn('number', 'Low (<40)');
	dt.addRows(raw);
	new google.visualization.ColumnChart(el).draw(dt, {
		title: 'Crash Discovery Timeline', isStacked: true,
		colors: ['#f87171', '#fbbf24', '#34d399'],
		legend: {position: 'top', textStyle: {color: '#94a3b8'}},
		chartArea: {width: '85%', height: '70%'},
		backgroundColor: '#162032',
		titleTextStyle: {color: '#94a3b8'},
		vAxis: {minValue: 0, textStyle: {color: '#64748b'}, gridlines: {color: 'rgba(255,255,255,0.05)'}, baselineColor: 'rgba(255,255,255,0.08)'},
		hAxis: {textStyle: {color: '#64748b'}},
		tooltip: {textStyle: {color: '#131c2e'}}
	});
}
</script>

{{end}}
