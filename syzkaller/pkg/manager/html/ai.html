{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
PROBE: AI Dashboard â€” summary overview with costs and full console.
*/}}

<style>
.tab-nav { display: flex; gap: 8px; margin-bottom: 16px; }
.tab-nav a { padding: 6px 16px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; }
.tab-nav a.active { background: #1a73e8; color: #fff; border-color: #1a73e8; }
.summary-cards { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
.card { border: 1px solid #ddd; border-radius: 8px; padding: 14px 18px; min-width: 150px; flex: 1; background: #f8f9fa; }
.card h3 { margin: 0 0 6px 0; font-size: 12px; color: #666; text-transform: uppercase; }
.card .value { font-size: 22px; font-weight: bold; }
.card .sub { font-size: 11px; color: #999; margin-top: 2px; }
.quick-links { display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap; }
.quick-links a { padding: 8px 20px; border: 1px solid #1a73e8; border-radius: 6px; text-decoration: none; color: #1a73e8; font-weight: 500; }
.quick-links a:hover { background: #e8f0fe; }
</style>

<div class="tab-nav">
  <a href="/ai" class="active">Dashboard</a>
  <a href="/ai/triage">AI Triage</a>
  <a href="/ai/embeddings">Embeddings</a>
  <a href="/ai/analytics">Analytics</a>
</div>

{{if .Disabled}}
<p>AI triage is disabled. Configure <code>ai_triage</code> in your config file with <code>model</code> and <code>api_key</code> to enable.</p>
{{else}}

<table class="list_table">
<caption>AI Status:</caption>
<tr><td class="title">Model</td><td>{{.Model}} ({{.Provider}})</td></tr>
<tr><td class="title">Status</td><td><span id="ai-status">{{.Status}}</span>{{if .NextBatchSec}} | Next batch: <span id="countdown"></span>{{end}}</td></tr>
</table>

<br>
<div class="summary-cards">
  <div class="card">
    <h3>Analyzed</h3>
    <div class="value">{{.AnalyzedCount}}</div>
    <div class="sub">crashes</div>
  </div>
  <div class="card">
    <h3>High Risk</h3>
    <div class="value" style="color:#c0392b">{{.HighRiskCount}}</div>
    <div class="sub">score &ge; 70</div>
  </div>
  <div class="card">
    <h3>Pending</h3>
    <div class="value">{{.PendingCount}}</div>
    <div class="sub">awaiting analysis</div>
  </div>
  <div class="card">
    <h3>Clusters</h3>
    <div class="value">{{.TotalClusters}}</div>
    <div class="sub">{{.TotalEmbeddings}} embeddings</div>
  </div>
  {{if .SyzGPTGenerated}}
  <div class="card">
    <h3>SyzGPT</h3>
    <div class="value">{{.SyzGPTValid}}/{{.SyzGPTGenerated}}</div>
    <div class="sub">{{.SyzGPTValidRate}}% valid, {{.SyzGPTInjected}} injected</div>
  </div>
  {{end}}
  {{if .HasStrategy}}
  <div class="card">
    <h3>Last Strategy</h3>
    <div class="value" style="font-size:14px">{{formatTime .StrategyTime}}</div>
  </div>
  {{end}}
</div>

<table class="list_table">
<caption>Claude (LLM) Cost:</caption>
<tr><td class="title">Today</td><td>{{.TodayCalls}} calls, {{.TodayTokens}} tokens, ${{printf "%.2f" .TodayCostUSD}} (~{{.TodayCostKRW}} KRW)</td></tr>
<tr><td class="title">Total</td><td>{{.TotalCalls}} calls, {{.TotalTokens}} tokens, ${{printf "%.2f" .TotalCostUSD}} (~{{.TotalCostKRW}} KRW)</td></tr>
</table>

{{if .EmbEnabled}}
<br>
<table class="list_table">
<caption>GPT Embedding Cost:</caption>
<tr><td class="title">Today</td><td>{{.EmbTodayCalls}} calls, {{.EmbTodayTokens}} tokens, ${{printf "%.4f" .EmbTodayCostUSD}} (~{{.EmbTodayCostKRW}} KRW)</td></tr>
<tr><td class="title">Total</td><td>{{.EmbTotalCalls}} calls, {{.EmbTotalTokens}} tokens, ${{printf "%.4f" .EmbTotalCostUSD}} (~{{.EmbTotalCostKRW}} KRW)</td></tr>
</table>

<br>
<table class="list_table">
<caption>Combined Total:</caption>
<tr><td class="title">Today</td><td>${{printf "%.4f" .CombinedTodayCostUSD}} (~{{.CombinedTodayCostKRW}} KRW)</td></tr>
<tr><td class="title">Total</td><td>${{printf "%.4f" .CombinedTotalCostUSD}} (~{{.CombinedTotalCostKRW}} KRW)</td></tr>
</table>
{{end}}

<br>
<div class="quick-links">
  <a href="/ai/triage">Triage &amp; Strategy &rarr;</a>
  <a href="/ai/embeddings">Embeddings &rarr;</a>
  <a href="/ai/analytics">Analytics &rarr;</a>
</div>

<br>
<b>Console (All)</b>
<div id="console" style="background:#1e1e1e; color:#d4d4d4; font-family:'Consolas','Courier New',monospace; font-size:12px; padding:10px; height:250px; overflow-y:auto; border:1px solid #555; border-radius:4px; margin-bottom:16px; white-space:pre-wrap;">Waiting for AI activity...
</div>

<script>
{{if .NextBatchSec}}
var nextBatch = {{.NextBatchSec}};
setInterval(function() {
	if (nextBatch <= 0) { nextBatch = 3600; }
	nextBatch--;
	var m = Math.floor(nextBatch/60), s = nextBatch%60;
	var el = document.getElementById('countdown');
	if (el) el.textContent = m + 'm ' + (s < 10 ? '0' : '') + s + 's';
}, 1000);
(function() {
	var m = Math.floor(nextBatch/60), s = nextBatch%60;
	var el = document.getElementById('countdown');
	if (el) el.textContent = m + 'm ' + (s < 10 ? '0' : '') + s + 's';
})();
{{end}}

var lastLogLen = 0;
var wasRunning = false;
var pollInterval = null;

function pollLog() {
	fetch('/api/ai/log').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c) return;
		var statusEl = document.getElementById('ai-status');
		if (statusEl) statusEl.textContent = data.running ? 'Running...' : 'Active';
		if (data.lines && data.lines.length > lastLogLen) {
			for (var i = lastLogLen; i < data.lines.length; i++) {
				var entry = data.lines[i];
				var t = new Date(entry.time);
				var ts = t.toLocaleTimeString('en-GB', {hour12: false});
				c.textContent += '[' + ts + '] ' + entry.message + '\n';
			}
			lastLogLen = data.lines.length;
			c.scrollTop = c.scrollHeight;
		}
		if (data.running) {
			wasRunning = true;
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 1500);
		} else {
			if (wasRunning) {
				wasRunning = false;
				setTimeout(function() { location.reload(); }, 1500);
				return;
			}
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 5000);
		}
	}).catch(function() {
		if (pollInterval) clearTimeout(pollInterval);
		pollInterval = setTimeout(pollLog, 3000);
	});
}

(function() {
	fetch('/api/ai/log').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c || !data.lines || data.lines.length === 0) return;
		c.textContent = '';
		for (var i = 0; i < data.lines.length; i++) {
			var entry = data.lines[i];
			var t = new Date(entry.time);
			var ts = t.toLocaleTimeString('en-GB', {hour12: false});
			c.textContent += '[' + ts + '] ' + entry.message + '\n';
		}
		lastLogLen = data.lines.length;
		c.scrollTop = c.scrollHeight;
		if (data.running) { wasRunning = true; }
		pollLog();
	});
})();
</script>

{{end}}
