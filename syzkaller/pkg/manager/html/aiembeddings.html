{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
PROBE: Phase 7e â€” GPTrace Embeddings page (format aligned with AI Triage).
*/}}

<div class="tab-nav">
  <a href="/ai">Dashboard</a>
  <a href="/ai/triage">AI Triage</a>
  <a href="/ai/embeddings" class="active">Embeddings</a>
  <a href="/ai/specgen">Spec Gen</a>
</div>

{{if .Disabled}}
<p>Embedding-based dedup is not configured. Set <code>embedding_api_key</code> and <code>embedding_model</code> in the <code>ai_triage</code> config block.</p>
{{else}}

<table class="list_table">
<caption>Embedding Status:</caption>
<tr><td class="title">Model</td><td>{{.Model}} ({{.Provider}})</td></tr>
<tr><td class="title">Embeddings</td><td>{{.TotalEmbeddings}} total, {{.TotalClusters}} clusters{{if .LargestCluster}}, largest cluster: {{.LargestCluster}}{{end}}</td></tr>
{{if .TotalEmbeddings}}<tr><td class="title">Dedup Ratio</td><td>{{printf "%.1f" .DedupRatio}}% ({{.TotalEmbeddings}} crashes &rarr; {{.TotalClusters}} unique groups)</td></tr>{{end}}
{{if .LastEmbeddingTime}}<tr><td class="title">Last Embedding</td><td>{{.LastEmbeddingTime}}</td></tr>{{end}}
</table>

<br>
<table class="list_table" style="width:auto">
<caption>Actions:</caption>
<tr>
	<td class="title" style="vertical-align:top">Crash Embeddings</td>
	<td>
		<button id="embedBtn" onclick="triggerEmbed()">Embed Now</button>
		<span style="color:var(--text-muted); font-size:12px; margin-left:6px">GPT embeds each crash report into a vector for semantic clustering</span>
	</td>
</tr>
</table>

<br>
<table class="list_table">
<caption>GPT Embedding Usage:</caption>
<tr><td class="title">Today</td><td>{{.TodayCalls}} calls, {{.TodayTokens}} tokens, ${{printf "%.4f" .TodayCostUSD}} (~{{.TodayCostKRW}} KRW)</td></tr>
<tr><td class="title">Total</td><td>{{.TotalCalls}} calls, {{.TotalTokens}} tokens, ${{printf "%.4f" .TotalCostUSD}} (~{{.TotalCostKRW}} KRW)</td></tr>
</table>

<br>
<div class="console-container" style="margin-top:20px">
<div class="console-header">EMBEDDINGS CONSOLE</div>
<div class="console-body" id="console" style="height:200px">Waiting for embedding activity...
</div>
</div>

{{if .Clusters}}
<table class="list_table">
<caption>Crash Clusters ({{.TotalClusters}}):</caption>
<thead><tr>
	<th>Cluster</th>
	<th>Representative Title</th>
	<th>Members</th>
	<th>Avg Similarity</th>
	<th>Crash IDs</th>
</tr></thead>
<tbody>
{{range .Clusters}}
<tr>
	<td class="stat">#{{.ID}}</td>
	<td class="title">{{.Title}}</td>
	<td class="stat">{{.Members}}</td>
	<td class="stat">{{printf "%.3f" .AvgSim}}</td>
	<td style="font-size:11px; max-width:400px; word-wrap:break-word">{{range .CrashIDs}}{{.}} {{end}}</td>
</tr>
{{end}}
</tbody>
</table>
{{else}}
<p>No clusters yet. Embeddings will be processed during the next batch cycle.</p>
{{end}}

{{if .CrashClusters}}
<br>
<table class="list_table">
<caption>Embedded Crashes ({{.TotalEmbeddings}}):</caption>
<thead><tr>
	<th>Crash ID</th>
	<th>Title</th>
	<th>Cluster</th>
	<th>Tokens</th>
</tr></thead>
<tbody>
{{range .CrashClusters}}
<tr>
	<td style="font-size:11px">{{.CrashID}}</td>
	<td class="title">{{.Title}}</td>
	<td class="stat">#{{.ClusterID}}</td>
	<td class="stat">{{.Tokens}}</td>
</tr>
{{end}}
</tbody>
</table>
{{end}}

{{if .History}}
<br>
<table class="list_table" id="historyTable">
<caption>API Call History ({{len .History}} total):</caption>
<thead><tr>
	<th>Time</th>
	<th>Type</th>
	<th>Tokens</th>
	<th>Cost</th>
	<th>Result</th>
</tr></thead>
<tbody>
{{range $i, $h := .History}}
<tr class="history-row" data-idx="{{$i}}">
	<td class="time">{{formatTime $h.Time}}</td>
	<td>{{$h.Type}}</td>
	<td class="stat">{{$h.Input}}</td>
	<td class="stat">${{printf "%.6f" $h.CostUSD}}</td>
	<td>{{if $h.Success}}OK{{else}}<span style="color:red">{{$h.Error}}</span>{{end}}</td>
</tr>
{{end}}
</tbody>
</table>
<div id="historyPager" style="margin:8px 0; display:flex; gap:6px; align-items:center; font-size:13px;"></div>
{{end}}

<script>
// Pagination for history table.
(function() {
	var PAGE_SIZE = 10;
	var rows = document.querySelectorAll('.history-row');
	if (!rows.length) return;
	var total = rows.length;
	var pages = Math.ceil(total / PAGE_SIZE);
	var cur = 0;
	function show(page) {
		cur = page;
		for (var i = 0; i < total; i++) {
			rows[i].style.display = (i >= page * PAGE_SIZE && i < (page + 1) * PAGE_SIZE) ? '' : 'none';
		}
		render();
	}
	function render() {
		var pager = document.getElementById('historyPager');
		if (!pager) return;
		var html = '';
		if (pages <= 1) { pager.innerHTML = ''; return; }
		html += '<button onclick="historyPage(0)" ' + (cur===0?'disabled':'') + '>&laquo;</button>';
		html += '<button onclick="historyPage('+(cur-1)+')" ' + (cur===0?'disabled':'') + '>&lsaquo;</button>';
		html += '<span>Page ' + (cur+1) + ' / ' + pages + '</span>';
		html += '<button onclick="historyPage('+(cur+1)+')" ' + (cur>=pages-1?'disabled':'') + '>&rsaquo;</button>';
		html += '<button onclick="historyPage('+(pages-1)+')" ' + (cur>=pages-1?'disabled':'') + '>&raquo;</button>';
		pager.innerHTML = html;
	}
	window.historyPage = function(p) { if (p >= 0 && p < pages) show(p); };
	show(0);
})();

var lastLogLen = 0;
var wasRunning = false;
var pollInterval = null;

function triggerEmbed() {
	var btn = document.getElementById('embedBtn');
	btn.disabled = true;
	btn.textContent = 'Embedding...';
	fetch('/api/ai/embed', {method: 'POST'}).then(function() {
		pollLog();
	}).catch(function(err) {
		appendLog('ERROR: ' + err);
		btn.disabled = false;
		btn.textContent = 'Embed Now';
	});
}

function appendLog(msg) {
	var c = document.getElementById('console');
	if (!c) return;
	var ts = new Date().toLocaleTimeString('en-GB', {hour12: false});
	c.textContent += '[' + ts + '] ' + msg + '\n';
	c.scrollTop = c.scrollHeight;
}

function pollLog() {
	fetch('/api/ai/log?filter=embeddings').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c) return;
		if (data.lines && data.lines.length > lastLogLen) {
			for (var i = lastLogLen; i < data.lines.length; i++) {
				var entry = data.lines[i];
				var t = new Date(entry.time);
				var ts = t.toLocaleTimeString('en-GB', {hour12: false});
				c.textContent += '[' + ts + '] ' + entry.message + '\n';
			}
			lastLogLen = data.lines.length;
			c.scrollTop = c.scrollHeight;
		}
		if (data.running) {
			wasRunning = true;
			var btn = document.getElementById('embedBtn');
			if (btn) { btn.disabled = true; btn.textContent = 'Embedding...'; }
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 1500);
		} else {
			var btn = document.getElementById('embedBtn');
			if (btn) { btn.disabled = false; btn.textContent = 'Embed Now'; }
			if (wasRunning) {
				wasRunning = false;
				appendLog('Completed. Refreshing page...');
				setTimeout(function() { location.reload(); }, 1500);
				return;
			}
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 5000);
		}
	}).catch(function() {
		if (pollInterval) clearTimeout(pollInterval);
		pollInterval = setTimeout(pollLog, 3000);
	});
}

// Initial load.
(function() {
	fetch('/api/ai/log?filter=embeddings').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c || !data.lines || data.lines.length === 0) return;
		c.textContent = '';
		for (var i = 0; i < data.lines.length; i++) {
			var entry = data.lines[i];
			var t = new Date(entry.time);
			var ts = t.toLocaleTimeString('en-GB', {hour12: false});
			c.textContent += '[' + ts + '] ' + entry.message + '\n';
		}
		lastLogLen = data.lines.length;
		c.scrollTop = c.scrollHeight;
		if (data.running) { wasRunning = true; }
		pollLog();
	});
})();
</script>

{{end}}
