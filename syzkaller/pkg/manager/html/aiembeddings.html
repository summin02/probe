{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
*/}}

{{/* PROBE: Phase 7e â€” GPTrace Embeddings Dashboard */}}
<style>
.tab-nav { display: flex; gap: 8px; margin-bottom: 16px; }
.tab-nav a { padding: 6px 16px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; }
.tab-nav a.active { background: #1a73e8; color: #fff; border-color: #1a73e8; }
.summary-cards { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
.card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; min-width: 180px; }
.card h3 { margin: 0 0 8px 0; font-size: 14px; color: #666; }
.card .value { font-size: 24px; font-weight: bold; }
table.bordered { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
table.bordered th, table.bordered td { border: 1px solid #ddd; padding: 6px 10px; text-align: left; }
table.bordered th { background: #f5f5f5; }
</style>

<div class="tab-nav">
  <a href="/ai">Dashboard</a>
  <a href="/ai/triage">AI Triage</a>
  <a href="/ai/embeddings" class="active">Embeddings</a>
  <a href="/ai/analytics">Analytics</a>
</div>

{{if .Disabled}}
<p>Embedding-based dedup is not configured. Set <code>embedding_api_key</code> and <code>embedding_model</code> in the <code>ai_triage</code> config block.</p>
{{else}}

<table class="list_table" style="width:auto">
<caption>Actions:</caption>
<tr>
	<td class="title" style="vertical-align:top">Crash Embeddings</td>
	<td>
		<button id="embedBtn" onclick="triggerEmbed()">Embed Now</button>
		<span style="color:#888; font-size:12px; margin-left:6px">GPT embeds each crash report into a vector for semantic clustering</span>
	</td>
</tr>
</table>
<br>

<div class="summary-cards">
  <div class="card">
    <h3>Total Embeddings</h3>
    <div class="value">{{.TotalEmbeddings}}</div>
  </div>
  <div class="card">
    <h3>Clusters</h3>
    <div class="value">{{.TotalClusters}}</div>
  </div>
  <div class="card">
    <h3>Largest Cluster</h3>
    <div class="value">{{.LargestCluster}}</div>
  </div>
  <div class="card">
    <h3>GPT Cost (USD)</h3>
    <div class="value">${{printf "%.4f" .EmbeddingCostUSD}}</div>
  </div>
  <div class="card">
    <h3>GPT Cost (KRW)</h3>
    <div class="value">{{.EmbeddingCostKRW}} won</div>
  </div>
  <div class="card">
    <h3>Tokens Used</h3>
    <div class="value">{{.EmbeddingTokens}}</div>
  </div>
  <div class="card">
    <h3>API Calls</h3>
    <div class="value">{{.EmbeddingCalls}}</div>
  </div>
  <div class="card">
    <h3>Last Embedding</h3>
    <div class="value" style="font-size:14px">{{.LastEmbeddingTime}}</div>
  </div>
</div>

<b>Console (Embeddings)</b>
<div id="console" style="background:#1e1e1e; color:#d4d4d4; font-family:'Consolas','Courier New',monospace; font-size:12px; padding:10px; height:180px; overflow-y:auto; border:1px solid #555; border-radius:4px; margin-bottom:16px; white-space:pre-wrap;">Waiting for embedding activity...
</div>

<h2>Crash Clusters</h2>
{{if .Clusters}}
<table class="bordered">
  <tr><th>Cluster</th><th>Representative Title</th><th>Members</th><th>Avg Similarity</th><th>Crash IDs</th></tr>
  {{range .Clusters}}
  <tr>
    <td>#{{.ID}}</td>
    <td>{{.Title}}</td>
    <td>{{.Members}}</td>
    <td>{{printf "%.3f" .AvgSim}}</td>
    <td>{{range .CrashIDs}}{{.}} {{end}}</td>
  </tr>
  {{end}}
</table>
{{else}}
<p>No clusters yet. Embeddings will be processed during the next AI batch cycle.</p>
{{end}}

<h2>Embedded Crashes</h2>
{{if .CrashClusters}}
<table class="bordered">
  <tr><th>Crash ID</th><th>Title</th><th>Cluster</th><th>Tokens</th></tr>
  {{range .CrashClusters}}
  <tr>
    <td>{{.CrashID}}</td>
    <td>{{.Title}}</td>
    <td>#{{.ClusterID}}</td>
    <td>{{.Tokens}}</td>
  </tr>
  {{end}}
</table>
{{else}}
<p>No embeddings yet.</p>
{{end}}

<script>
var lastLogLen = 0;
var wasRunning = false;
var pollInterval = null;

function triggerEmbed() {
	var btn = document.getElementById('embedBtn');
	btn.disabled = true;
	btn.textContent = 'Embedding...';
	fetch('/api/ai/embed', {method: 'POST'}).then(function() {
		pollLog();
	}).catch(function(err) {
		alert('Error: ' + err);
		btn.disabled = false;
		btn.textContent = 'Embed Now';
	});
}

function pollLog() {
	fetch('/api/ai/log?filter=embeddings').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c) return;
		if (data.lines && data.lines.length > lastLogLen) {
			for (var i = lastLogLen; i < data.lines.length; i++) {
				var entry = data.lines[i];
				var t = new Date(entry.time);
				var ts = t.toLocaleTimeString('en-GB', {hour12: false});
				c.textContent += '[' + ts + '] ' + entry.message + '\n';
			}
			lastLogLen = data.lines.length;
			c.scrollTop = c.scrollHeight;
		}
		if (data.running) {
			wasRunning = true;
			var btn = document.getElementById('embedBtn');
			if (btn) { btn.disabled = true; btn.textContent = 'Embedding...'; }
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 1500);
		} else {
			var btn = document.getElementById('embedBtn');
			if (btn) { btn.disabled = false; btn.textContent = 'Embed Now'; }
			if (wasRunning) {
				wasRunning = false;
				setTimeout(function() { location.reload(); }, 1500);
				return;
			}
			if (pollInterval) clearTimeout(pollInterval);
			pollInterval = setTimeout(pollLog, 5000);
		}
	}).catch(function() {
		if (pollInterval) clearTimeout(pollInterval);
		pollInterval = setTimeout(pollLog, 3000);
	});
}

// Initial load.
(function() {
	fetch('/api/ai/log?filter=embeddings').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c || !data.lines || data.lines.length === 0) return;
		c.textContent = '';
		for (var i = 0; i < data.lines.length; i++) {
			var entry = data.lines[i];
			var t = new Date(entry.time);
			var ts = t.toLocaleTimeString('en-GB', {hour12: false});
			c.textContent += '[' + ts + '] ' + entry.message + '\n';
		}
		lastLogLen = data.lines.length;
		c.scrollTop = c.scrollHeight;
		if (data.running) { wasRunning = true; }
		pollLog();
	});
})();
</script>

{{end}}
