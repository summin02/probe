{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
*/}}

<div id="metric-cards" class="summary-cards" style="display:none"></div>

<table class="list_table" id="stats-table">
	<tbody>
	{{range $s := $.Stats}}
	<tr>
		<td class="stat_name" title="{{$s.Hint}}">{{$s.Name}}</td>
		<td class="stat_value">
			{{if $s.Link}}
				<a href="{{$s.Link}}">{{$s.Value}}</a>
			{{else}}
				{{$s.Value}}
			{{end}}
		</td>
	</tr>
	{{end}}
	</tbody>
</table>

{{if .Crashes}}
<table class="list_table">
	<caption>Crashes:</caption>
	<thead>
	<tr>
		<th><a onclick="return sortTable(this, 'Description', textSort)" href="#">Description</a></th>
		<th><a onclick="return sortTable(this, 'AI', numSort)" href="#">AI</a></th>
		<th><a onclick="return sortTable(this, 'Rank', numSort)" href="#">Rank</a></th>
		<th><a onclick="return sortTable(this, 'Count', numSort)" href="#">Count</a></th>
		<th><a onclick="return sortTable(this, 'First Time', textSort, true)" href="#">First Time</a></th>
		<th><a onclick="return sortTable(this, 'Last Time', textSort, true)" href="#">Last Time</a></th>
		<th><a onclick="return sortTable(this, 'Report', textSort)" href="#">Report</a></th>
		<th><a onclick="return sortTable(this, 'Repro Attempts', numSort)" href="#">Repro Attempts</a></th>
	</tr>
	</thead>
	<tbody>
	{{range $c := $.Crashes}}
	<tr>
		<td class="title"><a href="/crash?id={{$c.ID}}">{{$c.Title}}</a></td>
		<td class="stat" {{if $c.AIScoreColor}}style="background:{{$c.AIScoreColor}}"{{end}}>{{if $c.AIScore}}<a href="/ai/crash?id={{$c.ID}}" style="color:inherit; text-decoration:none; font-weight:bold">{{$c.AIScore}}</a>{{else}}-{{end}}</td>
		<td class="rank {{if not $c.Active}}inactive{{end}}">
			{{if $c.RankTooltip}}
				<b>{{$c.Rank}}</b>
				<pre class="tooltiptext">{{$c.RankTooltip}}</pre>
			{{else}}
				{{$c.Rank}}
			{{end}}
		</td>
		<td class="stat {{if not $c.Active}}inactive{{end}}">{{len $c.Crashes}}</td>
		<td class="time {{if not $c.New}}inactive{{end}}">{{formatTime $c.FirstTime}}</td>
		<td class="time {{if not $c.Active}}inactive{{end}}">{{formatTime $c.LastTime}}</td>
		<td>
			{{if $c.Triaged}}
				<a href="/report?id={{$c.ID}}">{{$c.Triaged}}</a>
			{{end}}
			{{if $c.StraceFile}}
				<a href="/file?name={{$c.StraceFile}}">Strace</a>
			{{end}}
		</td>
		<td class="stat {{if not $c.ReproAttempts}}inactive{{end}}">{{$c.ReproAttempts}}</td>
	</tr>
	{{end}}
	</tbody>
</table>
{{end}}

{{define "diff_crashes"}}
<table class="list_table">
	<caption>{{.Title}}:</caption>
	<thead>
	<tr>
		<th>Description</th>
		<th>Base</th>
		<th>Patched</th>
	</tr>
	</thead>
	<tbody>
	{{range $bug := .List}}
	<tr>
		<td class="title">{{$bug.Title}}</td>
		<td class="title">
		{{if gt $bug.Base.Crashes 0}}
			{{$bug.Base.Crashes}} crashes
		{{else if $bug.Base.NotCrashed}}
			Not affected
		{{else}} ? {{end}}
		{{if $bug.Base.Report}}
			<a href="/file?name={{$bug.Base.Report}}">[report]</a>
		{{end}}
		</td>
		<td class="title">
		{{if gt $bug.Patched.Crashes 0}}
			{{$bug.Patched.Crashes}} crashes
		{{else}} ? {{end}}
		{{if $bug.Patched.Report}}
			<a href="/file?name={{$bug.Patched.Report}}">[report]</a>
		{{end}}
		{{if $bug.Patched.CrashLog}}
			<a href="/file?name={{$bug.Patched.CrashLog}}">[crash log]</a>
		{{end}}
		{{if $bug.Patched.Repro}}
			<a href="/file?name={{$bug.Patched.Repro}}">[syz repro]</a>
		{{end}}
		{{if $bug.Patched.ReproLog}}
			<a href="/file?name={{$bug.Patched.ReproLog}}">[repro log]</a>
		{{end}}
		{{if $bug.Reproducing}}[reproducing]{{end}}
		</td>
	</tr>
	{{end}}
	</tbody>
</table>
{{end}}

{{if .PatchedOnly}}
{{template "diff_crashes" .PatchedOnly}}
{{end}}

{{if .AffectsBoth}}
{{template "diff_crashes" .AffectsBoth}}
{{end}}

{{if .InProgress}}
{{template "diff_crashes" .InProgress}}
{{end}}

<div class="console-container">
	<div class="console-header">CONSOLE</div>
	<div class="console-body" id="log_textarea">{{.Log}}</div>
</div>

<script>
var HIGHLIGHT = {
	'exec total': {color: ''},
	'coverage': {color: 'var(--cyan)'},
	'corpus': {color: ''},
	'crash types': {color: 'var(--danger)'},
	'uptime': {color: 'var(--success)'},
	'candidates': {color: 'var(--warning)'}
};

function buildCards(table, cards) {
	if (!table || !cards) return;
	cards.innerHTML = '';
	var rows = table.querySelectorAll('tbody tr');
	var found = 0;
	for (var i = 0; i < rows.length; i++) {
		var cells = rows[i].querySelectorAll('td');
		if (cells.length < 2) continue;
		var name = cells[0].textContent.trim();
		var meta = HIGHLIGHT[name];
		if (!meta) continue;
		found++;
		var val = cells[1].textContent.trim();
		var link = cells[1].querySelector('a');
		var d = document.createElement('div');
		d.className = 'card';
		var valHtml = link ? '<a href="' + link.getAttribute('href') + '" style="color:inherit;text-decoration:none">' + val + '</a>' : val;
		var colorStyle = meta.color ? ' style="color:' + meta.color + '"' : '';
		d.innerHTML = '<h3>' + name + '</h3><div class="value"' + colorStyle + '>' + valHtml + '</div>';
		cards.appendChild(d);
		rows[i].style.display = 'none';
	}
	if (found > 0) cards.style.display = '';
}

// Initial render.
(function() {
	buildCards(document.getElementById('stats-table'), document.getElementById('metric-cards'));
	var log = document.getElementById('log_textarea');
	if (log) log.scrollTop = log.scrollHeight;
})();

// Live polling â€” refresh stats, crashes, and console every 5s.
(function() {
	var refreshing = false;
	setInterval(function() {
		if (refreshing) return;
		refreshing = true;
		fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
		.then(function(r) { return r.text(); })
		.then(function(html) {
			var parser = new DOMParser();
			var doc = parser.parseFromString(html, 'text/html');

			// Update stats table.
			var newTable = doc.getElementById('stats-table');
			var curTable = document.getElementById('stats-table');
			if (newTable && curTable) {
				curTable.querySelector('tbody').innerHTML = newTable.querySelector('tbody').innerHTML;
				// Show all rows first, then rebuild cards.
				curTable.querySelectorAll('tbody tr').forEach(function(r) { r.style.display = ''; });
				buildCards(curTable, document.getElementById('metric-cards'));
			}

			// Update console log.
			var newLog = doc.getElementById('log_textarea');
			var curLog = document.getElementById('log_textarea');
			if (newLog && curLog) {
				var wasAtBottom = curLog.scrollHeight - curLog.scrollTop - curLog.clientHeight < 40;
				curLog.textContent = newLog.textContent;
				if (wasAtBottom) curLog.scrollTop = curLog.scrollHeight;
			}

			// Re-apply i18n if active.
			var lang = localStorage.getItem('probe_lang');
			if (lang && lang !== 'en' && typeof applyI18n === 'function') applyI18n(lang);

			refreshing = false;
		}).catch(function() { refreshing = false; });
	}, 1000);
})();
</script>
